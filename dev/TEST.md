# 消息通知系统测试策略文档

## 1. 测试概述

### 1.1 测试目标
- 确保系统功能完整性和可靠性
- 验证系统性能和扩展性
- 保证系统安全性和数据一致性
- 提供全面的质量保证体系

### 1.2 测试范围
- **用户服务系统** (8080端口) - OAuth认证、WebSocket通信、消息API
- **管理后台系统** (8081端口) - 管理界面、权限管理、发送者管理
- **消息投递系统** - 队列管理、邮递员协程、存储机制
- **数据库系统** - SQLite用户存储、同步机制

### 1.3 测试层级
- **单元测试** - 函数级测试，覆盖率80%+
- **集成测试** - 模块间接口测试
- **端到端测试** - 完整业务流程测试
- **性能测试** - 负载和压力测试
- **安全测试** - 漏洞扫描和渗透测试

## 2. 关键功能模块测试方案

### 2.1 OAuth2认证系统测试

#### 2.1.1 单元测试
**测试文件**: `internal/auth/*_test.go`

```go
// JWT Token生成和验证测试
func TestJWTGenerationAndValidation(t *testing.T) {
    // 测试正常Token生成
    // 测试Token验证
    // 测试过期Token处理
    // 测试无效Token拒绝
    // 测试Token刷新机制
}

// OAuth2提供商集成测试
func TestOAuth2Providers(t *testing.T) {
    // 测试GitHub OAuth2流程
    // 测试Google OAuth2流程
    // 测试微信OAuth2流程
    // 测试错误处理和回调
}
```

**关键测试用例**:
- ✅ Token生成包含正确用户信息
- ✅ Token验证成功/失败场景
- ✅ 过期Token被正确拒绝
- ✅ 刷新Token机制正常工作
- ✅ OAuth2回调处理正确
- ✅ 错误状态处理完善

#### 2.1.2 集成测试
**测试目标**: 验证认证端到端流程

**测试场景**:
1. **完整登录流程**
   ```
   用户访问受保护页面 → 跳转OAuth2登录 → 授权成功 → 回调获取code →
   换取access_token → 生成JWT → 存储到客户端 → 访问API验证认证
   ```

2. **多设备登录管理**
   ```
   设备A登录 → 设备B登录 → 检查会话列表 →
   设备A强制下线 → 验证Token失效
   ```

3. **Token刷新流程**
   ```
   使用过期Token请求API → 收到401响应 →
   使用refresh_token刷新 → 获取新Token → 重试原请求
   ```

**验收标准**:
- OAuth2登录成功率100%
- Token验证响应时间<50ms
- 支持并发用户认证>1000/秒
- 错误处理完善，用户体验良好

#### 2.1.3 性能测试
**测试指标**:
- JWT生成性能: >5000次/秒
- Token验证性能: >10000次/秒
- OAuth2认证流程: <3秒完成
- 并发认证用户: >1000

**测试工具**: Apache JMeter / wrk

### 2.2 WebSocket实时通信测试

#### 2.2.1 连接管理测试
**测试文件**: `internal/websocket/*_test.go`

```go
// 连接建立和维护测试
func TestConnectionManagement(t *testing.T) {
    // 测试连接建立
    // 测试心跳检测
    // 测试连接断开处理
    // 测试多设备同时连接
    // 测试连接数限制
}

// 消息广播测试
func TestMessageBroadcasting(t *testing.T) {
    // 测试单播消息
    // 测试广播消息
    // 测试频道广播
    // 测试离线消息处理
}
```

**关键测试用例**:
- ✅ WebSocket连接建立成功率100%
- ✅ 心跳包定期发送和检测
- ✅ 连接断开后正确清理资源
- ✅ 多设备连接状态同步
- ✅ 消息实时推送延迟<100ms
- ✅ 离线消息缓存和重发

#### 2.2.2 集成测试
**测试场景**:

1. **多端同步测试**
   ```
   用户在设备A读取消息 → WebSocket状态更新 →
   设备B实时收到状态变更 → UI同步更新
   ```

2. **连接恢复测试**
   ```
   网络断开连接 → 重连机制触发 →
   恢复连接状态 → 同步离线期间的消息
   ```

3. **消息推送测试**
   ```
   系统发送消息 → 投递到用户存储 →
   WebSocket推送 → 所有在线设备接收
   ```

**验收标准**:
- 消息端到端延迟<100ms
- 支持10000并发连接
- 连接恢复成功率>95%
- 消息推送成功率>99.9%

#### 2.2.3 压力测试
**测试工具**: Artillery.js / WebSocket压测工具

**测试指标**:
- 并发连接数: 10000+
- 消息吞吐量: 50000条/秒
- 连接建立速率: 1000/秒
- 内存使用稳定性

### 2.3 消息发送API系统测试

#### 2.3.1 API接口测试
**测试文件**: `internal/api/*_test.go`

```go
// 消息发送API测试
func TestMessageSendingAPI(t *testing.T) {
    // 测试单条消息发送
    // 测试批量消息发送
    // 测试模板消息发送
    // 测试权限验证
    // 测试频率限制
}

// 服务认证测试
func TestServiceAuthentication(t *testing.T) {
    // 测试JWT用户认证
    // 测试Service API Key认证
    // 测试权限验证
    // 测试认证失败处理
}
```

**关键测试用例**:
- ✅ 单条消息发送成功
- ✅ 批量消息发送性能
- ✅ 消息模板变量替换
- ✅ 附件和操作按钮处理
- ✅ 服务认证API Key验证
- ✅ 频率限制机制
- ✅ 权限矩阵正确执行

#### 2.3.2 业务流程测试
**测试场景**:

1. **企业网盘文件分享通知**
   ```bash
   POST /api/v3/messages/send
   Authorization: Service netdrive_service_api_key
   {
       "template_id": "file_share",
       "recipients": ["user123"],
       "variables": {
           "sender_name": "张三",
           "file_name": "项目计划.pdf",
           "file_url": "https://drive.company.com/files/abc123"
       }
   }
   ```

   **验证点**: 模板渲染正确、接收者收到通知、附件链接有效

2. **文档协作邀请**
   ```bash
   POST /api/v3/messages/send
   Authorization: Service docs_system_api_key
   {
       "template_id": "doc_collaboration",
       "recipients": ["user789"],
       "variables": {
           "sender_name": "李四",
           "doc_title": "Q1销售报告",
           "permission": "编辑"
       }
   }
   ```

   **验证点**: 邀请信息准确、操作按钮有效、权限设置正确

3. **系统告警通知**
   ```bash
   POST /api/v3/messages/send
   Authorization: Service monitoring_api_key
   {
       "template_id": "system_alert",
       "recipients": ["admin_team"],
       "variables": {
           "alert_type": "数据库连接异常",
           "alert_message": "主数据库连接池耗尽"
       }
   }
   ```

   **验证点**: 告警级别正确、信息详细、处理建议有效

#### 2.3.3 性能测试
**测试指标**:
- 消息发送API响应时间<200ms (95%)
- 批量发送1000条消息<5秒
- 模板渲染性能>10000次/秒
- 并发发送能力>1000/秒

### 2.4 发送者管理系统测试

#### 2.4.1 发送者账户管理测试
**测试文件**: `internal/senders/*_test.go`

```go
// 发送者账户CRUD测试
func TestSenderAccountManagement(t *testing.T) {
    // 测试用户账户创建
    // 测试服务账户创建
    // 测试管理员账户创建
    // 测试账户权限配置
    // 测试账户状态管理
}

// 权限矩阵验证测试
func TestPermissionMatrix(t *testing.T) {
    // 测试用户账户权限
    // 测试服务账户权限
    // 测试管理员账户权限
    // 测试权限继承和覆盖
}
```

**关键测试用例**:
- ✅ 三种账户类型创建和管理
- ✅ 权限矩阵正确执行
- ✅ 服务账户API Key生成和验证
- ✅ 账户状态切换生效
- ✅ 权限变更实时生效

#### 2.4.2 服务账户审核流程测试
**测试场景**:

1. **服务账户申请流程**
   ```
   开发者提交申请 → 管理员收到通知 →
   审核申请材料 → 批准/拒绝 →
   自动创建账户 → 发送API Key
   ```

2. **权限配置和验证**
   ```
   分配基础权限 → 配置频率限制 →
   测试API调用 → 验证权限生效 →
   调整权限配置 → 验证变更
   ```

**验收标准**:
- 申请流程完整可追踪
- 权限配置准确生效
- API Key安全管理
- 审核日志完整记录

### 2.5 消息投递系统测试

#### 2.5.1 邮递员协程池测试
**测试文件**: `internal/delivery/*_test.go`

```go
// 投递任务处理测试
func TestDeliveryTaskProcessing(t *testing.T) {
    // 测试任务分发
    // 测试并发处理
    // 测试失败重试
    // 测试优先级处理
}

// 竞争让路机制测试
func TestCompetitiveYielding(t *testing.T) {
    // 测试数据库锁检测
    // 测试自动让路重试
    // 测试读取优先策略
    // 测试超时处理
}
```

**关键测试用例**:
- ✅ 投递任务正确分发到邮递员
- ✅ 并发投递性能达标
- ✅ 失败任务智能重试
- ✅ 优先级消息优先处理
- ✅ 数据库竞争时正确让路
- ✅ 读取操作优先保证

#### 2.5.2 队列管理测试
**测试场景**:

1. **多级队列处理**
   ```
   消息进入入口队列 → 按优先级分组 →
   分配到工作队列 → 邮递员处理 →
   完成或重试 → 清理队列
   ```

2. **背压控制测试**
   ```
   模拟高负载 → 队列积压 →
   触发背压控制 → 拒绝低优先级消息 →
   负载恢复 → 正常处理
   ```

**验收标准**:
- 队列处理性能>5000消息/秒
- 背压控制机制有效
- 无消息丢失或重复
- 内存使用稳定

### 2.6 SQLite存储系统测试

#### 2.6.1 数据库操作测试
**测试文件**: `internal/storage/*_test.go`

```go
// 数据库CRUD操作测试
func TestDatabaseOperations(t *testing.T) {
    // 测试消息写入
    // 测试消息查询
    // 测试已读状态更新
    // 测试事务处理
    // 测试并发访问
}

// 数据库同步测试
func TestDatabaseSynchronization(t *testing.T) {
    // 测试版本检查
    // 测试增量同步
    // 测试冲突解决
    // 测试数据一致性
}
```

**关键测试用例**:
- ✅ 消息写入性能和一致性
- ✅ 复杂查询响应时间
- ✅ 并发读写操作安全
- ✅ 事务ACID特性保证
- ✅ 数据库同步准确性
- ✅ 冲突解决机制有效

#### 2.6.2 数据库备份测试
**测试场景**:

1. **在线备份功能**
   ```
   用户请求备份 → 数据库锁定 →
   文件复制 → 压缩加密 →
   流式下载 → 解除锁定
   ```

2. **备份完整性验证**
   ```
   下载备份文件 → 校验文件完整性 →
   恢复到测试环境 → 对比数据一致性
   ```

**验收标准**:
- 备份过程不影响正常服务
- 备份文件100%完整
- 恢复后数据完全一致
- 大文件下载性能良好

## 3. 管理后台测试方案

### 3.1 WebComponent组件测试

#### 3.1.1 组件单元测试
**测试文件**: `admin-frontend/test/components/*_test.js`

```javascript
// admin-topbar组件测试
describe('admin-topbar', () => {
    test('导航事件正确触发', async () => {
        // 测试菜单点击
        // 验证事件触发
        // 检查参数正确性
    })

    test('通知徽章显示正确', async () => {
        // 测试徽章设置
        // 验证数字显示
        // 测试状态切换
    })
})

// admin-toast组件测试
describe('admin-toast', () => {
    test('消息显示和消失', async () => {
        // 测试success消息
        // 测试error消息
        // 测试自动消失
        // 测试手动关闭
    })
})
```

#### 3.1.2 组件集成测试
**关键测试用例**:
- ✅ 组件在主流浏览器兼容性
- ✅ 组件间事件通信正常
- ✅ 组件样式渲染正确
- ✅ 响应式设计适配
- ✅ 无障碍访问支持

### 3.2 页面功能测试

#### 3.2.1 发送者管理页面测试
**测试场景**:

1. **发送者列表展示**
   ```
   访问发送者管理页面 → 验证列表数据 →
   测试筛选功能 → 测试搜索功能 →
   验证分页正常
   ```

2. **服务账户创建**
   ```
   点击创建服务账户 → 填写账户信息 →
   配置发送权限 → 设置频率限制 →
   提交创建 → 验证账户生成
   ```

**验收标准**:
- 页面加载时间<3秒
- 数据展示准确完整
- 操作流程顺畅无错误
- 权限控制有效

#### 3.2.2 权限管理页面测试
**测试场景**:

1. **角色权限配置**
   ```
   选择角色 → 配置权限 →
   保存设置 → 验证权限生效 →
   测试权限边界
   ```

2. **服务账户审核**
   ```
   查看待审核申请 → 审核申请材料 →
   批准/拒绝 → 配置账户参数 →
   完成审核流程
   ```

### 3.3 端到端测试

#### 3.3.1 完整业务流程测试
**测试工具**: Playwright / Cypress

**测试场景**:

1. **管理员配置服务账户流程**
   ```
   管理员登录 → 创建服务账户 → 配置权限 →
   生成API Key → 使用API Key发送测试消息 →
   验证消息投递成功
   ```

2. **用户接收消息流程**
   ```
   用户OAuth登录 → WebSocket连接 →
   服务发送消息 → 用户实时接收 →
   标记已读 → 验证多端同步
   ```

**验收标准**:
- 端到端流程成功率100%
- 用户体验流畅无障碍
- 数据一致性保证
- 错误处理友好

## 4. 性能测试方案

### 4.1 负载测试

#### 4.1.1 API负载测试
**测试目标**: 验证系统在高并发下的性能表现

**测试场景**:
- 1000并发用户发送消息
- 500并发WebSocket连接
- 10000消息队列处理
- 数据库并发读写操作

**性能指标**:
| 指标 | 目标值 | 测试方法 |
|------|--------|----------|
| API响应时间 | P95 < 200ms | JMeter压测 |
| 消息投递延迟 | < 100ms | 端到端测试 |
| WebSocket并发 | 10000+ | Artillery.js |
| 数据库吞吐量 | 5000 ops/s | sysbench |
| 内存使用 | < 8GB | 系统监控 |

#### 4.1.2 压力测试
**测试目标**: 找到系统性能瓶颈和极限

**测试步骤**:
1. 逐步增加并发用户数(100→1000→5000→10000)
2. 监控系统资源使用率
3. 记录性能拐点和错误率
4. 分析瓶颈原因

### 4.2 稳定性测试

#### 4.2.1 长时间运行测试
**测试时长**: 72小时连续运行

**监控指标**:
- 内存泄漏检测
- CPU使用率稳定性
- 数据库连接池状态
- 消息队列积压情况

#### 4.2.2 故障恢复测试
**测试场景**:
- 数据库连接中断恢复
- Redis缓存失效恢复
- 网络分区恢复
- 服务器重启恢复

## 5. 安全测试方案

### 5.1 认证安全测试

#### 5.1.1 JWT安全测试
**测试用例**:
- ✅ Token签名验证
- ✅ Token篡改检测
- ✅ 过期Token拒绝
- ✅ 刷新Token安全
- ✅ 密钥强度验证

#### 5.1.2 OAuth2安全测试
**测试用例**:
- ✅ CSRF攻击防护
- ✅ 状态参数验证
- ✅ 重定向URI验证
- ✅ 授权码安全交换

### 5.2 API安全测试

#### 5.2.1 输入验证测试
**测试文件**: `test/security/input_validation_test.go`

```go
// SQL注入防护测试
func TestSQLInjectionPrevention(t *testing.T) {
    maliciousInputs := []string{
        "'; DROP TABLE messages; --",
        "' OR '1'='1",
        "1' UNION SELECT * FROM users --",
    }
    // 验证所有恶意输入都被正确处理
}

// XSS防护测试
func TestXSSPrevention(t *testing.T) {
    xssPayloads := []string{
        "<script>alert('xss')</script>",
        "javascript:alert('xss')",
        "onmouseover=alert('xss')",
    }
    // 验证XSS载荷被正确转义
}
```

#### 5.2.2 权限控制测试
**测试场景**:
- 垂直权限提升测试
- 水平权限访问测试
- 功能越权访问测试
- 资源访问控制测试

### 5.3 网络安全测试

#### 5.3.1 传输安全测试
**检查项**:
- ✅ HTTPS强制使用
- ✅ TLS配置安全性
- ✅ 安全头设置
- ✅ CORS策略配置

#### 5.3.2 会话安全测试
**检查项**:
- ✅ 会话Cookie安全属性
- ✅ 会话超时机制
- ✅ 并发会话限制
- ✅ 会话注销功能

## 6. 自动化测试策略

### 6.1 测试环境搭建

#### 6.1.1 Docker测试环境
```yaml
# docker-compose.test.yml
version: '3.8'
services:
  app:
    build: .
    environment:
      - ENV=testing
      - DB_URL=sqlite:///test.db
    depends_on:
      - redis
      - postgres

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"

  postgres:
    image: postgres:14-alpine
    environment:
      POSTGRES_DB: test_db
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
```

#### 6.1.2 测试数据准备
```bash
#!/bin/bash
# scripts/setup-test-data.sh
# 创建测试用户
# 创建测试频道
# 准备测试消息
# 设置测试权限
```

### 6.2 CI/CD集成

#### 6.2.1 GitHub Actions配置
```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version: 1.19

      - name: Run unit tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Run integration tests
        run: go test -v -tags=integration ./test/integration/...

      - name: Run e2e tests
        run: npm run test:e2e

      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

### 6.3 测试报告

#### 6.3.1 覆盖率报告
**目标**: 单元测试覆盖率80%+

**报告内容**:
- 总体覆盖率统计
- 分模块覆盖率详情
- 未覆盖代码分析
- 覆盖率趋势变化

#### 6.3.2 性能基准报告
**报告指标**:
- API响应时间基准
- 数据库操作性能
- 内存使用情况
- 错误率统计

## 7. 测试执行计划

### 7.1 测试阶段安排

#### 7.1.1 第一阶段：基础测试 (第1-2周)
- 单元测试开发和执行
- 基础组件集成测试
- 开发环境验收测试

#### 7.1.2 第二阶段：功能测试 (第3-4周)
- API接口功能测试
- WebSocket通信测试
- 认证授权测试

#### 7.1.3 第三阶段：系统测试 (第5-6周)
- 端到端业务流程测试
- 管理后台功能测试
- 数据一致性测试

#### 7.1.4 第四阶段：专项测试 (第7-8周)
- 性能压力测试
- 安全漏洞扫描
- 兼容性测试

#### 7.1.5 第五阶段：验收测试 (第9周)
- 用户验收测试
- 生产环境验证
- 测试报告总结

### 7.2 测试资源配置

#### 7.2.1 测试环境
- **开发测试环境**: 开发者本地使用
- **集成测试环境**: CI/CD自动化测试
- **性能测试环境**: 专用压测环境
- **预生产环境**: 生产环境镜像

#### 7.2.2 测试工具链
- **后端测试**: Go testing + testify
- **前端测试**: Jest + Playwright
- **性能测试**: JMeter + Artillery.js
- **安全测试**: OWASP ZAP + GoSec
- **监控工具**: Prometheus + Grafana

## 8. 风险和应急预案

### 8.1 测试风险识别

#### 8.1.1 技术风险
| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| 测试环境不稳定 | 中 | 高 | 多套备份环境，容器化部署 |
| 测试数据不足 | 中 | 中 | 自动化数据生成工具 |
| 性能测试工具限制 | 低 | 中 | 多工具对比验证 |
| 安全测试不全面 | 中 | 高 | 专业安全团队介入 |

#### 8.1.2 进度风险
| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| 测试用例设计延期 | 中 | 中 | 提前开始，并行开发 |
| 缺陷修复时间过长 | 高 | 高 | 优先级管理，快速补丁 |
| 测试环境准备延迟 | 低 | 中 | 自动化环境部署 |
| 回归测试范围扩大 | 中 | 中 | 自动化回归测试 |

### 8.2 应急预案

#### 8.2.1 环故障应急
1. **测试环境宕机**
   - 立即切换到备份环境
   - 通知运维团队修复
   - 调整测试计划

2. **数据损坏或丢失**
   - 从最新备份恢复
   - 重新初始化测试数据
   - 分析损坏原因

#### 8.2.2 进度延期应急
1. **测试进度滞后**
   - 增加测试人力投入
   - 优先执行核心功能测试
   - 延后非关键测试项目

2. **严重缺陷影响发布**
   - 快速跟踪缺陷修复
   - 评估发布风险
   - 准备回滚方案

## 9. 测试成功标准

### 9.1 质量标准

#### 9.1.1 功能质量
- ✅ 所有核心功能100%通过测试
- ✅ 用户场景端到端测试通过率100%
- ✅ 数据一致性验证通过
- ✅ 权限控制测试无例外

#### 9.1.2 性能标准
- ✅ API响应时间P95 < 200ms
- ✅ WebSocket消息延迟 < 100ms
- ✅ 支持10000并发连接
- ✅ 系统可用性 > 99.9%

#### 9.1.3 安全标准
- ✅ 通过OWASP安全检查
- ✅ 无高危安全漏洞
- ✅ 认证授权机制完善
- ✅ 数据传输加密

### 9.2 交付标准

#### 9.2.1 测试文档
- [ ] 测试计划和用例完整
- [ ] 测试数据和环境说明
- [ ] 测试结果分析报告
- [ ] 性能基准和监控指标

#### 9.2.2 自动化体系
- [ ] CI/CD自动化测试流水线
- [ ] 回归测试自动化覆盖率90%+
- [ ] 性能测试自动化执行
- [ ] 安全扫描自动化集成

#### 9.2.3 运维就绪
- [ ] 监控告警系统配置
- [ ] 日志收集和分析系统
- [ ] 备份恢复流程验证
- [ ] 应急响应预案制定

---

**文档版本**: v1.0
**创建时间**: 2025-01-15
**最后更新**: 2025-01-15
**测试负责人**: 测试团队
**审核人**: 项目经理、技术负责人

**联系方式**:
- 测试团队: test-team@company.com
- 项目管理: pm@company.com
- 技术支持: tech-lead@company.com